---
title: å£°éŸ³çš„åˆ†æå’Œå¤„ç†
description: JavaScript å®ç°å£°éŸ³çš„åˆ†æå’Œå¤„ç†
keywords: JavaScript, webapi, audio.api, canvas
---

# å£°éŸ³çš„åˆ†æå’Œå¤„ç†

## æ•ˆæœå±•ç¤º

ç°æœ‰ä¸€ä¸ªéœ€æ±‚ï¼šåœ¨ç”¨æˆ·æ’­æ”¾éŸ³é¢‘æ–‡ä»¶æ—¶ï¼Œæœ‰ç›¸åº”çš„å£°æ³¢åŠ¨ç”»æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![éŸ³é¢‘æ’­æ”¾æ•ˆæœ](https://pic.imgdb.cn/item/65338863c458853aefa5efc0.gif)

## å‰ç½®çŸ¥è¯†

é¦–å…ˆéœ€è¦äº†è§£ `audio.api` çš„ç›¸å…³çŸ¥è¯†ï¼Œè¯·æ³¨æ„ï¼Œè¿™ä¸æ˜¯å†™ä¸€ä¸ª `audio` æ ‡ç­¾è°ƒç”¨ `play()` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸“é—¨å¤„ç†éŸ³é¢‘æ•°æ®çš„ã€‚

æƒ³è¦äº†è§£è¿™ä¸ª API æ–¹æ³•ï¼Œéœ€è¦äº†è§£ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

1. éŸ³é¢‘ä¸Šä¸‹æ–‡ `AudioContent` ï¼ˆå³æ‰€æœ‰èŠ‚ç‚¹çš„é›†åˆï¼Œæ˜¯ä¸€ä¸ªç¯å¢ƒï¼Œç”¨äºç®¡ç†èŠ‚ç‚¹ï¼‰
2. å¤„ç†èŠ‚ç‚¹ï¼ˆå³å¤„ç†éŸ³é¢‘æ•°æ®çš„ç¯èŠ‚ï¼‰

### requestAnimationFrame() 

**`window.requestAnimationFrame()`** å‘Šè¯‰æµè§ˆå™¨â€”â€”ä½ å¸Œæœ›æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ï¼Œå¹¶ä¸”è¦æ±‚æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°æ›´æ–°åŠ¨ç”»ã€‚è¯¥æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨æµè§ˆå™¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡Œã€‚

> [!NOTE] ğŸ“ å¤‡æ³¨
> è‹¥ä½ æƒ³åœ¨æµè§ˆå™¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰ç»§ç»­æ›´æ–°ä¸‹ä¸€å¸§åŠ¨ç”»ï¼Œé‚£ä¹ˆå›è°ƒå‡½æ•°è‡ªèº«å¿…é¡»å†æ¬¡è°ƒç”¨ `requestAnimationFrame()`ã€‚`requestAnimationFrame()` æ˜¯ä¸€æ¬¡æ€§çš„ã€‚

å½“ä½ å‡†å¤‡æ›´æ–°åœ¨å±åŠ¨ç”»æ—¶ä½ åº”è¯¥è°ƒç”¨æ­¤æ–¹æ³•ã€‚è¿™å°†ä½¿æµè§ˆå™¨åœ¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨ä½ ä¼ å…¥ç»™è¯¥æ–¹æ³•çš„åŠ¨ç”»å‡½æ•°ï¼ˆå³ä½ çš„å›è°ƒå‡½æ•°ï¼‰ã€‚å›è°ƒå‡½æ•°æ‰§è¡Œæ¬¡æ•°é€šå¸¸æ˜¯æ¯ç§’ 60 æ¬¡ï¼Œä½†åœ¨å¤§å¤šæ•°éµå¾ª W3C å»ºè®®çš„æµè§ˆå™¨ä¸­ï¼Œå›è°ƒå‡½æ•°æ‰§è¡Œæ¬¡æ•°é€šå¸¸ä¸æµè§ˆå™¨å±å¹•åˆ·æ–°æ¬¡æ•°ç›¸åŒ¹é…ã€‚ä¸ºäº†æé«˜æ€§èƒ½å’Œç”µæ± å¯¿å‘½ï¼Œåœ¨å¤§å¤šæ•°æµè§ˆå™¨é‡Œï¼Œå½“ `requestAnimationFrame()` è¿è¡Œåœ¨åå°æ ‡ç­¾é¡µæˆ–è€…éšè—çš„ [``](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe) é‡Œæ—¶ï¼Œ`requestAnimationFrame()` ä¼šè¢«æš‚åœè°ƒç”¨ä»¥æå‡æ€§èƒ½å’Œç”µæ± å¯¿å‘½ã€‚

[`DOMHighResTimeStamp`](https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp) å‚æ•°ä¼šä¼ å…¥å›è°ƒæ–¹æ³•ä¸­ï¼Œå®ƒæŒ‡ç¤ºå½“å‰è¢« `requestAnimationFrame()` æ’åºçš„å›è°ƒå‡½æ•°è¢«è§¦å‘çš„æ—¶é—´ã€‚åœ¨åŒä¸€ä¸ªå¸§ä¸­çš„å¤šä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒä»¬æ¯ä¸€ä¸ªéƒ½ä¼šæ¥å—åˆ°ä¸€ä¸ªç›¸åŒçš„æ—¶é—´æˆ³ï¼Œå³ä½¿åœ¨è®¡ç®—ä¸Šä¸€ä¸ªå›è°ƒå‡½æ•°çš„å·¥ä½œè´Ÿè½½æœŸé—´å·²ç»æ¶ˆè€—äº†ä¸€äº›æ—¶é—´ã€‚è¯¥æ—¶é—´æˆ³æ˜¯ä¸€ä¸ªåè¿›åˆ¶æ•°ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œæœ€å°ç²¾åº¦ä¸º 1msï¼ˆ1000Î¼sï¼‰ã€‚

> [!WARNING] âš ï¸ è­¦å‘Š
> è¯·ç¡®ä¿æ€»æ˜¯ä½¿ç”¨ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆæˆ–å…¶ä»–ä¸€äº›è·å–å½“å‰æ—¶é—´çš„æ–¹æ³•ï¼‰æ¥è®¡ç®—åŠ¨ç”»åœ¨ä¸€å¸§ä¸­çš„è¿›åº¦ï¼Œ**å¦åˆ™åŠ¨ç”»åœ¨é«˜åˆ·æ–°ç‡çš„å±å¹•ä¸­ä¼šè¿è¡Œå¾—æ›´å¿«**ã€‚è¯·å‚è€ƒä¸‹é¢ç¤ºä¾‹çš„åšæ³•ã€‚

è¯­æ³•

```js
requestAnimationFrame(callback)
```

å‚æ•°ï¼š[`callback`](https://developer.mozilla.org/zh-CN/docs/Web/API/window/requestAnimationFrame#callback)ã€‚å½“ä½ çš„åŠ¨ç”»éœ€è¦æ›´æ–°æ—¶ï¼Œä¸ºä¸‹ä¸€æ¬¡é‡ç»˜æ‰€è°ƒç”¨çš„å‡½æ•°ã€‚è¯¥å›è°ƒå‡½æ•°ä¼šä¼ å…¥ [`DOMHighResTimeStamp`](https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp) å‚æ•°ï¼Œè¯¥å‚æ•°ä¸ [`performance.now()`](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/now) çš„è¿”å›å€¼ç›¸åŒï¼Œå®ƒè¡¨ç¤º `requestAnimationFrame()` å¼€å§‹æ‰§è¡Œå›è°ƒå‡½æ•°çš„æ—¶åˆ»ã€‚

è¿”å›å€¼ï¼šä¸€ä¸ª `long` æ•´æ•°ï¼Œè¯·æ±‚ IDï¼Œæ˜¯å›è°ƒåˆ—è¡¨ä¸­å”¯ä¸€çš„æ ‡è¯†ã€‚æ˜¯ä¸ªéé›¶å€¼ï¼Œæ²¡æœ‰åˆ«çš„æ„ä¹‰ã€‚ä½ å¯ä»¥ä¼ è¿™ä¸ªå€¼ç»™ [`window.cancelAnimationFrame()`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/cancelAnimationFrame) ä»¥å–æ¶ˆå›è°ƒå‡½æ•°è¯·æ±‚ã€‚

### AudioContext.createAnalyser()

[`AudioContext`](https://developer.mozilla.org/zh-CN/docs/Web/API/AudioContext)çš„`createAnalyser()`æ–¹æ³•èƒ½åˆ›å»ºä¸€ä¸ª[`AnalyserNode`](https://developer.mozilla.org/zh-CN/docs/Web/API/AnalyserNode)ï¼Œå¯ä»¥ç”¨æ¥è·å–éŸ³é¢‘æ—¶é—´å’Œé¢‘ç‡æ•°æ®ï¼Œä»¥åŠå®ç°æ•°æ®å¯è§†åŒ–ã€‚

è¯­æ³•

```js
var audioCtx = new AudioContext();
var analyser = audioCtx.createAnalyser();
```

è¿”å›å€¼

[`AnalyserNode`](https://developer.mozilla.org/zh-CN/docs/Web/API/AnalyserNode)å¯¹è±¡

### AnalyserNode.fftSize

[`AnalyserNode`](https://developer.mozilla.org/zh-CN/docs/Web/API/AnalyserNode) æ¥å£çš„ `fftSize` å±æ€§çš„å€¼æ˜¯ä¸€ä¸ªæ— ç¬¦å·é•¿æ•´å‹çš„å€¼ï¼Œè¡¨ç¤ºï¼ˆä¿¡å·ï¼‰æ ·æœ¬çš„çª—å£å¤§å°ã€‚å½“æ‰§è¡Œ[å¿«é€Ÿå‚…é‡Œå¶å˜æ¢](https://developer.mozilla.org/zh-CN/docs/Web)ï¼ˆFast Fourier Transfor (FFT)ï¼‰æ—¶ï¼Œè¿™äº›ï¼ˆä¿¡å·ï¼‰æ ·æœ¬è¢«ç”¨æ¥è·å–é¢‘åŸŸæ•°æ®ã€‚

`fftSize` å±æ€§çš„å€¼å¿…é¡»æ˜¯ä» 32 åˆ° 32768 èŒƒå›´å†…çš„ 2 çš„éé›¶å¹‚; å…¶é»˜è®¤å€¼ä¸º 2048.

> [!NOTE] ğŸ“ å¤‡æ³¨
> å¦‚æœå…¶å€¼ä¸æ˜¯ 2 çš„å¹‚ï¼Œæˆ–è€…å®ƒåœ¨æŒ‡å®šèŒƒå›´ä¹‹å¤–ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ INDEX_SIZE_ERR.

è¯­æ³•

```js
var audioCtx = new AudioContext();
var analyser = audioCtx.createAnalyser();
analyser.fftSize = 2048;
```

å€¼ï¼šä¸€ä¸ªæ— ç¬¦å·é•¿æ•´å‹ã€‚

### AnalyserNode.getByteFrequencyData()

[`AnalyserNode`](https://developer.mozilla.org/zh-CN/docs/Web/API/AnalyserNode)æ¥å£çš„ **`getByteFrequencyData()`** æ–¹æ³•å°†å½“å‰é¢‘ç‡æ•°æ®å¤åˆ¶åˆ°ä¼ å…¥çš„ Uint8Arrayï¼ˆæ— ç¬¦å·å­—èŠ‚æ•°ç»„ï¼‰ä¸­ã€‚

å¦‚æœæ•°ç»„çš„é•¿åº¦å°äº [`AnalyserNode.frequencyBinCount`](https://developer.mozilla.org/zh-CN/docs/Web/API/AnalyserNode/frequencyBinCount), é‚£ä¹ˆ Analyser å¤šå‡ºçš„å…ƒç´ ä¼šè¢«åˆ é™¤ã€‚å¦‚æœæ˜¯å¤§äºï¼Œé‚£ä¹ˆæ•°ç»„å¤šä½™çš„å…ƒç´ ä¼šè¢«å¿½ç•¥ã€‚

è¯­æ³•

```js
var audioCtx = new AudioContext();
var analyser = audioCtx.createAnalyser();
var dataArray = new Uint8Array(analyser.frequencyBinCount); // Uint8Array çš„é•¿åº¦åº”è¯¥å’Œ frequencyBinCount ç›¸ç­‰
analyser.getByteFrequencyData(dataArray); // è°ƒç”¨ getByteFrequencyData æ–¹æ³•å¡«å…… Uint8Array
```

è¿”å›å€¼ï¼šä¸€ä¸ª [`Uint8Array` (en-US)](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array)ï¼ˆæ— ç¬¦å·å­—èŠ‚æ•°ç»„ï¼‰.

## æ•ˆæœå®ç°

è¿™ä¸ªæ•ˆæœï¼Œæ˜¯é€šè¿‡ `canvas` ç”»å¸ƒç”»ä¸€ä¸ªåœ†ï¼Œç„¶åé€šè¿‡ç»˜åˆ¶çº¿çš„é•¿åº¦å³å¯å®ç°æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![åˆæ­¥æ•ˆæœ](https://pic.imgdb.cn/item/65339234c458853aefc6455d.jpg)

ç°åœ¨é‡ç‚¹æ˜¯å¦‚ä½•è·å–éŸ³é¢‘çš„æ•°æ®ã€‚éœ€è¦å…ˆç‚¹å‡» `audio` æ ‡ç­¾æ‰èƒ½æ’­æ”¾éŸ³é¢‘ï¼Œå› æ­¤å»ç›‘å¬å…¶æ’­æ”¾äº‹ä»¶ï¼Œç›‘å¬äº‹ä»¶åšä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š

1. åˆ¤æ–­å˜é‡æ˜¯å¦åˆå§‹åŒ–ï¼Œå¦‚æœå·²ç»åˆå§‹åŒ–åˆ™è¿”å›ï¼Œä¸ç”¨å†åˆ›å»º
2. åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
3. ä½¿ç”¨ `createAnalyser()` æ–¹æ³•åˆ›å»ºä¸€ä¸ªéŸ³é¢‘åˆ†æå™¨èŠ‚ç‚¹
4. è°ƒç”¨ `getByteFrequencyData(æ•°ç»„)` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥è·å–é™„è¿‘ä¸€å°æ®µæ—¶é—´å†…éŸ³é¢‘çš„é¢‘ç‡ï¼Œå› æ­¤éœ€è¦ä¸æ–­è°ƒç”¨è¯¥æ–¹æ³•ï¼ŒæŠŠè¯¥æ–¹æ³•æå–å‡ºå»ã€‚æœ€ååˆ†æå‡ºæ¥çš„ç»“æœä¼šæ”¾åˆ°æ‹¬å·å†…çš„æ•°ç»„é‡Œ
5. è°ƒç”¨ `fftSize` å±æ€§æ§åˆ¶éŸ³é¢‘è·å–çš„é¢‘ç‡ç²¾ç»†ç¨‹åº¦
6. ä½¿ç”¨ `createMediaElementSource()` æ–¹æ³•å»ºç«‹éŸ³é¢‘æ¥æºèŠ‚ç‚¹
7. è¿æ¥éŸ³é¢‘æ¥æºèŠ‚ç‚¹å’ŒéŸ³é¢‘åˆ†æèŠ‚ç‚¹
8. åˆå§‹åŒ–å˜é‡è®¾ç½®ä¸º `true` 
9. æœ€åæ‹“å±•å®Œå–„ï¼ŒæŠŠéŸ³é¢‘é¢‘ç‡æ•°ç»„ç©ºçš„éƒ¨åˆ†å»æ‰ï¼Œå†é€šè¿‡è®¡ç®—è®©å…¶è§†è§‰æ•ˆæœè¿è´¯

ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
let isInit = false // æ˜¯å¦åˆå§‹åŒ–
const analyser, buffer

audioElm.onplay = function() {
  // å¦‚æœå·²ç»åˆå§‹åŒ–åˆ™ä¸ç”¨ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
  if(isInit) return
  
  // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
  const audioCtx = new AudioContent()
  // åˆ›å»ºåˆ†æèŠ‚ç‚¹
  analyser = audioCtx.createAnalyser()
  analyser.fftSize = 512
  // åˆ›å»ºä¿å­˜éŸ³é¢‘é¢‘ç‡çš„æ•°ç»„
  buffer = new Uinit8Array(analyser.frequencyBinCount)
  
  // å»ºç«‹éŸ³é¢‘æ¥æºçš„ä¿¡æ¯ï¼Œè¿æ¥éŸ³é¢‘æ¥æºèŠ‚ç‚¹å’ŒéŸ³é¢‘åˆ†æèŠ‚ç‚¹
  const source = audioCtx.createMediaElementSource(audioElm)
  source.connect(analyser)
  
  // éŸ³é¢‘æ’­æ”¾è¿æ¥åˆ°å–‡å­ï¼Œæ’­æ”¾ç»™ç”¨æˆ·å¬
  analyser.connect(audioCtx.destination)
}

function update() {
  requestAnimationFrame(update)
  if(!isInit) return
  
  analyser.getByteFrequencyData(buffer)
  
  // ç¨åšå¤„ç†ï¼ŒæŠŠéŸ³é¢‘æ•°ç»„å†…éƒ¨åˆ†ç©ºçš„éƒ¨åˆ†å»é™¤æ‰ï¼›å¹¶è®©æ•°ç»„æ•´ä½“é•¿åº¦ä¸º2å€ï¼Œä¿å­˜æ—¶å¯¹åº”é¦–å°¾éƒ½ä¿å­˜ï¼Œåšå¯¹ç§°ä¿å­˜
  const offest = Math.floor(buffer.length * 2 / 3)
  const datas = new Array(offest * 2)
  for(let i = 0; i < offest; i++) {
      datas[i] = datas[datas.length - 1 - i] = buffer[i]
  }
  console.log(buffer)
}
update()
```

## æ‹“å±•ï¼šè·å–éº¦å…‹é£æ•°æ®

å®é™…ä¸Š `createMediaElementSource()` æ–¹æ³•è¿æ¥éŸ³é¢‘æ•°æ®æ¥æºä¸ä»…ä»…å¯ä»¥è¿æ¥ `audo` æ ‡ç­¾çš„éŸ³é¢‘æ¥æºï¼Œä¹Ÿå¯ä»¥è¿æ¥ç”¨æˆ·çš„éº¦å…‹é£æ•°æ®ã€‚

åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š

1. è°ƒç”¨å†…ç½® API æ–¹æ³• `navigator.mediaDevices.getUserMedia()` è·å–éº¦å…‹é£æ•°æ®ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨éœ€è¦äº‹å…ˆè·å–ç”¨æˆ·çš„éº¦å…‹é£æƒé™ï¼‰
2. ä¿®æ”¹éŸ³é¢‘æ¥æºè¿æ¥æ–¹æ³•  `createMediaElementSource()` çš„å‚æ•°ä¸ºéº¦å…‹é£

ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š

```js
navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
  // ...
  const source = audioCtx.createMediaElementSource(stream)
  source.connect(analyser)
  
  // analyser.connect(aduioCtx.destination)
  isInit = true
})

// ...
```

