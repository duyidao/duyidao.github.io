# éœ€æ±‚æ¶æ„è®¾è®¡å¹¶ä¼˜é›…å®ç°

## éœ€æ±‚åˆ†æ

å‡è®¾æœ‰ä¸€ä¸ªå·¥ä½œå°é¦–é¡µï¼Œç›®å‰é¢ä¸´ä»¥ä¸‹æƒ…å†µï¼š

1. éœ€è¦è¯·æ±‚ä¸€ä¸ªæ¥å£ï¼Œå¼¹å‡ºå¯¹åº”çš„æç¤ºï¼ˆå¦‚ç»­è´¹ã€æ·»åŠ å¸¸ç”¨åº”ç”¨ç­‰ï¼‰ï¼Œéšç€åç»­çš„æ›´æ–°è¿­ä»£ï¼Œå¯èƒ½ä¼šæœ‰å„ç§ç±»å‹çš„æç¤º
2. åœ¨åˆ«çš„é¡µé¢è¿›è¡Œäº†æŸäº›æ“ä½œåï¼Œé¦–é¡µè¦æ„ŸçŸ¥åˆ°ï¼Œå¹¶æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
3. å…¶ä»–æƒ…å†µï¼Œå¦‚ `websocket` æ¨é€å¤„ç†ç­‰

## ä»€ä¹ˆæ˜¯æ¶æ„

ä¿éšœæ‹“å±•æ€§ã€ç»´æŠ¤æ€§ã€å¤ç”¨æ€§ï¼Œä»¥åŠä½è€¦åˆçš„åŸåˆ™ä¸‹è®¾è®¡å‡ºå“ªäº›æ¨¡å—ï¼Œä»¥åŠæ¨¡å—ä¹‹é—´æ€ä¹ˆäº¤æµã€‚

å› æ­¤çœ‹åˆ°éœ€æ±‚ç¬¬ä¸€æ­¥ï¼Œå…ˆæƒ³æ€ä¹ˆæ‹†åˆ†æ¨¡å—ï¼Œä¿è¯ä»¥ä¸‹ä¸¤ç‚¹ï¼š

- èŒè´£å•ä¸€
- æ¨¡å—æ¶ˆæ¯ä¼ é€’æ²Ÿé€šï¼Œä¸ç›´æ¥è°ƒç”¨

## æ¶æ„è®¾è®¡

è¿˜æ˜¯ä»¥ä¸Šè¿°çš„éœ€æ±‚ä¸ºä¾‹å­ï¼Œå¯ä»¥æŠŠè¿™ä¸ªé¦–é¡µéœ€æ±‚ä¸­å„ç§å¼¹çª—ç»„ä»¶æŠ½ç¦»å‡ºæ¥ç»Ÿä¸€åœ¨ `src/components/modelCommponent` æ–‡ä»¶å¤¹å†…ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ `index.js` å’Œä¸€ä¸ªåŠ¨æ€ç»„ä»¶ `model.vue`ï¼Œå¯¼å‡ºç›¸å…³çš„ç»„ä»¶é…ç½®ã€‚æ ¹æ®é…ç½®æ–‡ä»¶æ‰¾åˆ°å¯¹åº”çš„ç»„ä»¶ã€‚

æ‹¿åˆ°å¯¹åº”çš„ç»„ä»¶åï¼Œæ¸²æŸ“åˆ°åŠ¨æ€ç»„ä»¶ `model.vue` ä¸­ï¼Œé¦–é¡µç›´æ¥ä½¿ç”¨åŠ¨æ€ç»„ä»¶ï¼Œé€šè¿‡çˆ¶å­ä¼ å‚è¦æ˜¾ç¤ºçš„å¼¹çª— `code` å³å¯ã€‚

::: code-group

```vue [App.vue]
<script setup>
import { ref } from "vue";
import model from "./components/model.vue";
const modelCode = ref("qianfei");
</script>

<template>
  <div>
    <model :modelCode="modelCode" />
  </div>
</template>
```

```js [components/modelCommponent/index.js]
import compA from "./components/compA.vue";
import compB from "./components/compB.vue";

export default [
  {
    code: "qianfei",
    component: compA,
  },
  {
    code: "changyong",
    component: compB,
  },
];
```

```vue [components/modelCommponent/model.vue]
<script setup>
import config from './index.js'
const { modelCode } = defineProps(['modelCode'])

fucntion findComponent(code) {
  const list = config.filter(comp => comp.code === code)
  return list[0].component
}
</script>

<template>
  <component :is="findComponent(modelCode)" />
</template>
```

```vue [components/modelCommponent/components/compA.vue]
<template>
  <div>ä½ å·²æ¬ è´¹</div>
</template>
```

```vue [components/modelCommponent/components/compB.vue]
<template>
  <div>æ·»åŠ å¸¸ç”¨</div>
</template>
```

:::

ç›®å‰çš„æ¶æ„å·²ç»å®ç°ä½è€¦åˆå’Œæ˜“æ‹“å±•ï¼Œä½†æ˜¯åªèƒ½é¦–é¡µå’ŒåŠ¨æ€å¼¹çª—ç»„ä»¶å®ç°æ²Ÿé€šï¼Œå…¶ä»–é¡µé¢çš„æ“ä½œé¦–é¡µæ— æ³•æ„ŸçŸ¥åˆ°ã€‚å› æ­¤è¿˜éœ€è¦å®ç°æ²Ÿé€šæ•ˆæœã€‚

## æ²Ÿé€š

æƒ³è¦å®ç°æ²Ÿé€šï¼Œä½†æ˜¯åˆè¦æ³¨é‡è§£è€¦ï¼Œè®©ç»„ä»¶é›†åˆæ¨¡å—ç‹¬ç«‹äºé¦–é¡µï¼Œæ˜¾ç¤ºæ¥æºè‡ªç”±ã€‚ç›®å‰çš„å†™æ³•å¹¶ä¸æ˜¯è‡ªç”±çš„ï¼Œæ˜¯ä¾é é¦–é¡µä¼ å…¥çš„ã€‚

è§£è€¦çš„ä¸‡èƒ½æ‰‹æ®µâ€”â€”ç¬¬ä¸‰æ–¹è§‚å¯Ÿè€…ã€‚å› æ­¤æœ€ç»ˆæ¶æ„è®¾è®¡å¦‚ä¸‹ï¼š

![æœ€ç»ˆæ¶æ„è®¾è®¡](https://pic1.imgdb.cn/item/67ebe5690ba3d5a1d7e957f9.png)

é¦–å…ˆäº‹ä»¶è§‚å¯Ÿè€…æ¨¡å—ï¼Œæä¾›æ³¨å†Œå’Œè§¦å‘äº‹ä»¶çš„æ–¹æ³•ï¼Œè§¦å‘äº‹ä»¶åï¼Œä»æ³¨å†Œçš„ç›‘å¬æ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº”æ–¹æ³•ï¼Œæå–åŠ¨æ€ç»„ä»¶æ˜¾ç¤ºã€‚ä¹Ÿå°±æ˜¯ä¸å†ä»é¦–é¡µçˆ¶å­ä¼ å‚æ¥æ¸²æŸ“åŠ¨æ€ç»„ä»¶ï¼Œè€Œæ˜¯äº¤ç»™ç¬¬ä¸‰æ–¹è§‚å¯Ÿè€…ã€‚

`src` æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ª `eventObj` æ–‡ä»¶å¤¹ï¼Œæ–°å»ºä¸€ä¸ª `index.js` ä½œä¸ºäº‹ä»¶è§‚å¯Ÿè€…æ¨¡å—ï¼Œå£°æ˜ä¸€ä¸ªå¯¹è±¡ `subMap` ç”¨äºè®°å½•ä»¥åŠç›‘å¬ã€‚å¯¼å‡º `on` å’Œ `emit` æ–¹æ³•ï¼Œ`on` æ–¹æ³•ç”¨äºæ³¨å†Œäº‹ä»¶ï¼Œ`emit` æ–¹æ³•ç”¨äºè§¦å‘äº‹ä»¶ã€‚

åœ¨å¼¹çª—åŠ¨æ€ç»„ä»¶è°ƒç”¨ `on` æ–¹æ³•ï¼Œå¾ªç¯ä¿å­˜çš„å¼¹çª—ç»„ä»¶é›†åˆï¼Œç»™æ¯ä¸€ä¸ªç»„ä»¶å¯¹åº”çš„ `code` æ·»åŠ äº‹ä»¶ç»‘å®šå¹¶ä¿å­˜åˆ° `pinia` ä¸­ï¼›åœ¨é¦–é¡µæ¥å£è·å–åˆ°æ•°æ®åè°ƒç”¨ `emit` æ–¹æ³•ï¼ŒæŠŠæ•°æ®ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè§¦å‘äº‹ä»¶ï¼Œäº‹ä»¶è§‚å¯Ÿè€…æ¨¡å—ä¼šä» `subMap` ä¸­æ‰¾åˆ°å¯¹åº”çš„äº‹ä»¶ï¼Œå¹¶æ‰§è¡Œã€‚

æœ€åå¾ªç¯ `pinia` ä¿å­˜åˆ°çš„éœ€è¦å±•ç¤ºçš„å¼¹çª—æ•°ç»„ï¼Œçˆ¶å­ä¼ å‚ï¼Œå­ç»„ä»¶æ ¹æ®å‚æ•°å„è‡ªæ¸²æŸ“éœ€è¦æ¸²æŸ“çš„æ•°æ®å³å¯ã€‚

::: code-group

```js [eventObj/index.js]
const subMap = {};

export default {
  on(eventType, fn) {
    subMap[eventType] = fn;
  },
  emit(eventType, ...args) {
    subMap[eventType] && subMap[eventType].apply(undefined, ...args);
  },
};
```

```js [store/index.js]
import { reactive } from "vue";
import { defineStore } from "pinia";

export const useIndexEvents = defineStore("indexEvents", () => {
  const hasEmitList = reactive([]);
  const addInHasEmitList = (eventData) => {
    hasEmitList.push(eventData);
  };
  return {
    hasEmitList,
    addInHasEmitList,
  };
});
```

```vue [components/modelCommponent/model.vue]
<script setup>
import config from './index.js'
import eventObj from '@/eventObj/index.js' // [!code ++]
import { useIndexEvents } from '@/store' // [!code ++]

const store = useIndexEvents() // [!code ++]

config.forEach(comp => { // [!code ++]
  eventObj.on(comp.code, (eventData) => { // [!code ++]
    store.addInHasEmitList(eventData) // [!code ++]
  }) // [!code ++]
}) // [!code ++]

const { modelCode } = defineProps(['modelCode'])

fucntion findComponent(code) {
  const list = config.filter(comp => comp.code === code)
  return list[0].component
}
</script>

<template>
  <component :is="findComponent(modelCode)" />
</template>
<template>
  <div v-for="item in store?.hasEmitList" :key="item.code">
    <!-- [!code ++] -->
    <component :is="findComponent(item.code)" :data="item.data" />
    <!-- [!code ++] -->
    <!-- [!code ++] -->
  </div>
  <!-- [!code ++] -->
  <component :is="findComponent(modelCode)" />
  <!-- [!code --] -->
</template>
```

```vue [App.vue]
<script setup>
import { ref } from "vue";
import model from "./components/model.vue";
import eventObj from "@/eventObj/index.js"; // [!code ++]

const modelCode = ref("qianfei"); // [!code --]
// æ¨¡æ‹Ÿæ¥å£è°ƒç”¨ // [!code ++]
setTimeout(() => {
  // [!code ++]
  const res = {
    // [!code ++]
    code: "qianfei", // [!code ++]
  }; // [!code ++]
  eventObj.emit(res.code, {
    // [!code ++]
    code: res.code, // [!code ++]
    data: {
      // [!code ++]
      time: 20, // [!code ++]
      // ä¼ å…¶ä»–çš„å‚æ•° // [!code ++]
    }, // [!code ++]
  }); // [!code ++]
}, 1000); // [!code ++]
</script>

<template>
  <div>
    <model />
    <!-- [!code ++] -->
    <model :modelCode="modelCode" />
    <!-- [!code --] -->
  </div>
</template>
```

```vue [components/modelCommponent/components/compA.vue]
<script setup>
// [!code ++]
const { data } = defineProps(["data"]); // [!code ++]
</script>
<!-- [!code ++] -->

<template>
  <div>ä½ å·²æ¬ è´¹ + {{ data.time }} + å¤©</div>
  <!-- [!code ++] -->
</template>
```

:::

> [!TIP] ğŸ“— è¡¥å……
> è¿™é‡Œä½¿ç”¨ `apply` æ˜¯å› ä¸º `emit` æ–¹æ³•è§¦å‘äº‹ä»¶æ—¶ï¼Œéœ€è¦ä¼ é€’å¤šä¸ªå‚æ•°ï¼Œè€Œ `fn` æ–¹æ³•éœ€è¦æ¥å—å¤šä¸ªå‚æ•°ï¼Œå› æ­¤ä½¿ç”¨ `apply` æ–¹æ³•æ¥ä¼ é€’å‚æ•°ã€‚
