---
title: ä¼˜åŒ–é¡¹ç›®é€Ÿåº¦
isReship: true
author:
  - ä¸‰åçš„å‰ç«¯è¯¾ å‰ç«¯å¦‚ä½•ç”¨æ—¶é—´åˆ‡ç‰‡ä¼˜åŒ–é¡¹ç›®é€Ÿåº¦^https://www.bilibili.com/video/BV1F94y1i7iq/
  - ä¸‰åçš„å‰ç«¯è¯¾ å‰ç«¯webworkeræç¤ºæ€§èƒ½å®æˆ˜æ¡ˆä¾‹^https://www.bilibili.com/video/BV1z2421P7Qm/
---

# ä¼˜åŒ–é¡¹ç›®é€Ÿåº¦

## RequestAnimation

### éœ€è¦åŸå› 

å¦‚æœä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ JS æ“ä½œï¼Œå¯èƒ½ä¼šé˜»å¡æµè§ˆå™¨çš„æ¸²æŸ“ï¼Œè¿™æ ·æˆ‘ä»¬é¡µé¢å°±çœ‹ä¸åˆ°ååº”ï¼Œå¯¼è‡´é•¿æ—¶é—´ç™½å±ï¼Œæˆ–è€…é¡µé¢ä¸å±•ç¤ºä»»ä½•æ•ˆæœã€‚

è§£å†³æ–¹æ³•ä¸ºæŠŠæ“ä½œåˆ‡æˆä¸€ç‰‡ä¸€ç‰‡çš„ï¼Œå…ˆæ“ä½œä¸€ç‰‡ï¼Œæ“ä½œå®Œåæ¸²æŸ“ï¼Œå†æ“ä½œä¸‹ä¸€ç‰‡ã€‚

ç”¨ä¸€å‰¯å›¾ä¾‹æ¥è¯´æ˜å¦‚ä¸‹ï¼š

![requestAnimationå›¾ä¾‹è¯´æ˜](https://pic1.imgdb.cn/item/67ebe93b0ba3d5a1d7e95a5e.png)

ä¾‹å¦‚ï¼Œæˆ‘è¦æ¸²æŸ“ä¸€ä¸ªè¡¨æ ¼ï¼Œè¯¥è¡¨æ ¼æœ‰ 50000 æ¡æ•°æ®ï¼Œåˆ™å…‰æ˜¯æ¸²æŸ“å’Œæ»‘åŠ¨å°±æœ‰å¾ˆæ˜æ˜¾çš„å¡é¡¿ç°è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```js
const dateArr = reactive([]);

for (let i = 0; i < 50000; i++) {
  dateArr.push({
    id: 1,
    name: "å¼ ä¸‰",
    status: Math.floor(Math.random() * 3),
    checked: false,
  });
}
```

ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡ï¼ŒæŠŠæ¸²æŸ“æ“ä½œåˆ†æˆ 500 ä¸ªå°ç‰‡æ®µï¼Œæ¯æ¬¡æ¸²æŸ“ 500 æ¡æ•°æ®ï¼Œæ¸²æŸ“å®Œæˆåå†æ¸²æŸ“ä¸‹ä¸€æ‰¹ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰å¡é¡¿ç°è±¡ã€‚

### å®ç°

`requestAnimation` å®šä¹‰çš„ä»»åŠ¡ï¼Œä¼šåœ¨æµè§ˆå™¨æ¸²æŸ“å®Œæˆåå»æ‰§è¡Œã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŠŠæ¯ä¸ªåˆ‡ç‰‡æ”¾åˆ° `requestAnimation` ã€‚å®ƒåœ¨æ‰§è¡Œå®Œä¸€ä¸ªåï¼Œä¼šç­‰ç€æµè§ˆå™¨æ¸²æŸ“å®Œæˆå†æ‰§è¡Œä¸‹ä¸€ä¸ªã€‚

ä¸‹é¢é€šè¿‡ä»£ç æ¥å®ç°è¿™ä¸€æ€æƒ³ï¼Œè¿˜æ˜¯ä»¥ä¸Šæ–¹æ¡ˆä¾‹ä¸ºä¾‹ï¼š

```js
const dateArr = reactive([]);

let index = 0;
function sliceRender() {
  requestAnimationFrame(() => {
    let target = index + 500; // æ¯æ¬¡æ¸²æŸ“500æ¡æ•°æ®
    for (; index < target; index++) {
      dateArr.push({
        id: 1,
        name: "å¼ ä¸‰",
        status: Math.floor(Math.random() * 3),
        checked: false,
      });
    }

    if (index < 50000) sliceRender(); // å¦‚æœä¸å¤Ÿ5ä¸‡æ¡æ•°æ®ï¼Œç»§ç»­æ¸²æŸ“
  });
}

sliceRender();
```

ä¸Šæ–¹ä»£ç åˆ©ç”¨æ—¶é—´åˆ‡ç‰‡çš„æ€æƒ³ï¼Œå…ˆåˆ‡å‡º 500 æ¡æ•°æ®ï¼Œæ¸²æŸ“æˆåŠŸåˆ°é¡µé¢ä¸Šåå†è·å–åç»­çš„æ•°æ®ï¼Œæ­¤æ—¶é¡µé¢ç”¨æˆ·åœ¨çœ‹å‰ 500 æ¡æ•°æ®ï¼Œåç»­çš„æ•°æ®åœ¨æ‚„æ‚„æ¸²æŸ“ã€‚è¿™æ ·å°±ä¸ä¼šæœ‰å¡é¡¿çš„æ•ˆæœã€‚

é€‰æ‹©å…¨éƒ¨ä¹Ÿæ˜¯è¿™ä¸ªé“ç†ï¼Œé€‰æ‹©å…¨éƒ¨çš„åŠŸèƒ½æ˜¯æŠŠæ‰€æœ‰åˆ—è¡¨çš„ `id` æ·»åŠ åˆ°æ‰€é€‰æ•°ç»„å†…ï¼Œè€Œä¸€æ¬¡æ€§æŠŠ 50000 æ¡æ•°æ®éƒ½ä¸€æ¬¡æ€§æ·»åŠ åˆ°æ•°ç»„ä¸­éœ€è¦ä¸€å®šçš„æ—¶é—´æ¶ˆè€—ã€‚å› æ­¤å¯ä»¥åˆ©ç”¨åˆ‡ç‰‡çš„æ€æƒ³ï¼Œåˆ‡ç‰‡æ·»åŠ æ•°æ®ã€‚

ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
let choseList = [];
// ç‚¹å‡»å…¨é€‰å¤é€‰æ¡†
const selectAllFn = (e) => {
  let index = 0;
  function choseAllID() {
    if (e.target.value) {
      requestAnimationFrame(() => {
        for (; index < target; index++) {
          let target = index + 500;
          choseList.push(dateArr[index.id]);
        }
        if (index < dateArr.length) choseAllID();
      });
    }
  }

  choseAllID();
};
```

### æ€»ç»“

åœ¨ä¼˜åŒ–é¡¹ç›®æ—¶ï¼Œä¸åªæ˜¯è¦è¿½æ±‚ç»å¯¹çš„é€Ÿåº¦æå‡ï¼Œåœ¨æ— æ³•è¿›ä¸€æ­¥æå‡æ—¶å¯ä»¥æƒ³åŠæ³•è®©ç”¨æˆ·ä½“éªŒæ›´å¥½ã€‚

æ¯”å¦‚æ—¶é—´åˆ‡ç‰‡ï¼Œå¼‚æ­¥åŠ è½½ï¼Œè¿™äº›æ“ä½œå¯¹æ•´ä½“é€Ÿåº¦éƒ½æ²¡æœ‰æå‡ï¼Œä½†æ˜¯é€šè¿‡åˆç†å®‰æ’é¡ºåºï¼Œå¯ä»¥è®©ä½“éªŒæ›´å¥½ã€‚

é™¤äº†è¿™æ¬¡çš„è¡¨æ ¼æ¡ˆä¾‹ï¼Œå¦ä¸€ä¸ªå¦‚å¤šä¸ª `echarts` è¡¨å›¾æ¸²æŸ“æ¡ˆä¾‹ä¹Ÿå¯ä»¥é€‚ç”¨ã€‚å¤šä¸ªå›¾ç»˜åˆ¶å¤ªæ…¢ï¼Œå¯ä»¥å…ˆç»˜åˆ¶ä¸€ä¸ªï¼Œå®Œæˆåå†ç»˜åˆ¶ä¸€ä¸ªã€‚

## webworker

ä¼—æ‰€å‘¨çŸ¥ï¼ŒJavaScript ä¸€ç›´è¢«è¯´ä¸æ“…é•¿è®¡ç®—ï¼Œå› ä¸ºå®ƒæ˜¯åŒæ­¥çš„ï¼Œå¤§è§„æ¨¡è®¡ç®—ä¼šè®©ä¸»çº¿ç¨‹å µå¡ï¼Œç»“æœå°±æ˜¯ç•Œé¢å®Œå…¨å¡æ­»ã€‚

### å¼‚æ­¥

è€Œå¼‚æ­¥å¹¶ä¸æ˜¯æœ€ç»ˆæœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆï¼Œå¼‚æ­¥åªæ˜¯æŠŠä»»åŠ¡å‘å¸ƒå‡ºå»ç­‰å¾…ï¼Œåé¢è¿˜æ˜¯ä¼šæ‹‰åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå¼‚æ­¥ä¸å¯èƒ½å†å¼‚æ­¥é˜Ÿåˆ—è‡ªå·±æ‰§è¡Œã€‚æ‰€ä»¥æ˜¯ä¸€ä¸ªè€—æ—¶å¾ˆé«˜çš„æ“ä½œï¼Œæ— è®ºåšä¸åšå¼‚æ­¥ï¼Œå®ƒå§‹ç»ˆéƒ½ä¼šå¯¼è‡´é¡µé¢å¡æ­»ã€‚

![å¼‚æ­¥å¤„ç†è€—æ—¶è¿ç®—](https://pic1.imgdb.cn/item/67ebf1c20ba3d5a1d7e95e2a.png)

å¦‚æœä¸€ä¸ªè€—æ—¶ä»»åŠ¡å¿…é¡»æ¶ˆè€— 2s å»è®¡ç®—ï¼Œä¸»çº¿ç¨‹æ°¸è¿œä¸å¯èƒ½èº²å¼€è¿™ 2s çš„è®¡ç®—æ—¶é—´ï¼Œåªèƒ½é€šè¿‡åˆ‡ç‰‡ç­‰æ“ä½œï¼ŒæŠŠè¿™ 2s çš„åˆ‡ç‰‡åˆ†ä¸ºå¥½å‡ ä¸ª å‡ åæ¯«ç§’ï¼Œä¸€ç‚¹ç‚¹è®¡ç®—æ¥è§£å†³å¡é¡¿é—®é¢˜ã€‚

### webworker

![webworker](https://pic1.imgdb.cn/item/67ebf3920ba3d5a1d7e95fce.png)

webworker æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹ï¼Œå¼€ä¸€æ¡æ”¯çº¿è®©å®ƒè®¡ç®—ï¼Œç„¶åæŠŠç»“æœè¿”å›ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œwebworker ä¸èƒ½ä½¿ç”¨æœ¬åœ°çš„ `js` æ–‡ä»¶ï¼Œåªèƒ½ä½¿ç”¨çº¿ä¸Šçš„ï¼Œè§£å†³æ–¹æ³•ä¸ºæŠŠéœ€è¦ä½¿ç”¨çš„ `js` æ–‡ä»¶æ”¾åˆ° `public` æ–‡ä»¶å¤¹ä¸‹ï¼Œå‘å¸ƒä¸Šçº¿åè®©åç«¯æˆ–è¿ç»´æŠŠå®ƒä¸¢åˆ°é™æ€èµ„æºä¸‹å³å¯ã€‚

::: code-group

```vue [App.vue]
<script>
let worker = new Worker("http://localhost:3000/worker.js", { type: "module" });
worker.addEventListener("message", (e) => {
  console.log(e.data);
});
</script>

<template>
  <button @click="() => worker.postMessage('ä½ å¥½ğŸ‘‹')">click me</button>
</template>
```

```js [worker.js]
let a = 2;
worker.postMessage(a); // æŠŠæ•°æ®è¿”å›ç»™ä¸»çº¿ç¨‹

// ç›‘å¬ä¸»çº¿ç¨‹ä¼ äº†ä»€ä¹ˆ
worker.addEventListener("message", (e) => {
  console.log(e.data); // ä¸»çº¿ç¨‹ä¼ æ¥çš„æ•°æ®
  worker.postMessage("æ”¶åˆ°ğŸ«¡"); // æŠŠæ•°æ®è¿”å›ç»™ä¸»çº¿ç¨‹
});
```

:::

#### æ³¨æ„äº‹é¡¹

1. webworker ä¸èƒ½ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œå¿…é¡»æ˜¯ç½‘ç»œä¸ŠåŒæºæ–‡ä»¶
2. webworker ä¸èƒ½ä½¿ç”¨ window ä¸Šçš„ DOM æ“ä½œï¼Œä¹Ÿä¸èƒ½è·å– DOM å¯¹è±¡ï¼ŒDOM ç›¸å…³çš„ä¸œè¥¿åªæœ‰ä¸»çº¿ç¨‹æœ‰ï¼Œwebworker åªèƒ½åšè®¡ç®—ç›¸å…³çš„æ“ä½œ
3. æœ‰çš„ä¸œè¥¿æ— æ³•é€šè¿‡ä¸»çº¿ç¨‹ä¼ é€’ç»™å­çº¿ç¨‹ï¼Œæ¯”å¦‚è¯´ DOM èŠ‚ç‚¹ã€å¯¹è±¡ç‰¹æ®Šè®¾ç½®ï¼ˆå¦‚ `freeze` ã€`getter` ç­‰ï¼ŒVue å“åº”å¼å¯¹è±¡æ— æ³•ä¼ é€’ï¼‰
4. æ¨¡å—çš„å¼•å…¥é—®é¢˜

   å› ä¸º webworker åªèƒ½ä½¿ç”¨ç½‘ç»œä¸Šçš„æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ `import` ï¼Œåªèƒ½ä½¿ç”¨ `importScripts` ï¼Œä¸”æ‹¬å·å†…åªèƒ½å†™ç½‘ç»œåœ°å€ï¼Œä¸è¿‡è¯¥åœ°å€å¯ä»¥è·¨åŸŸã€‚

   å¦‚æœå¼•ç”¨çš„ `js` æ–‡ä»¶æ˜¯ esmodule è§„èŒƒçš„è¯ï¼Œwebworker å¿…é¡»è¦åŠ ç±»å‹æè¿°è¯´æ˜ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

   å¦‚æœä½¿ç”¨äº† `type` ä¸º `module` é‚£ä¹ˆæ— éœ€ä½¿ç”¨ `importScripts` ï¼Œç›´æ¥ä½¿ç”¨ `import` å³å¯ã€‚

#### å¸¸è§åº”ç”¨

1. `webgl` ã€`canvas` ç­‰å¯è§†åŒ–æ“ä½œï¼Œå¦‚åœ¨çº¿æ»¤é•œã€åœ¨çº¿ç»˜å›¾ã€web æ¸¸æˆç­‰è€—æ—¶è®¡ç®—å¯ä»¥ä½¿ç”¨ webworker

   ::: code-group

   ```js [æ™®é€šä½¿ç”¨.js]
   function img() {
     const data = ctx.getImageData(0, 0, 1800, 900);
     for (let i = 0; i < data.data.length; i++) {
       for (let j = 0; j < 255; j++) {
         if (data.data[i] !== 255) data.data[i] = Math.min(data[i] + j, 0);
       }
     }

     ctx.putImageData(data, 0, 0); // è€—æ—¶2s
   }
   ```

   ```js [worker.js]
   worker.addEventListener("message", (e) => {
     if (e.data.data.length) {
       let data = e.data;
       for (let i = 0; i < data.data.length; i++) {
         for (let j = 0; j < 255; j++) {
           if (data.data[i] !== 255)
             data.data[i] = Math.min(data.data[i] + j, 0);
         }
       }
       worker.postMessage(data); // è€—æ—¶0.5s
     }
   });
   ```

   ```vue [app.vue]
   <script>
   let worker = new Worker("http://localhost:3000/worker.js", {
     type: "module",
   });
   worker.addEventListener("message", (e) => {
     console.log(e.data);
     ctx.putImageData(e.data, 0, 0);
   });

   function img() {
     const data = ctx.getImageData(0, 0, 1800, 900);
     worker.postMessage(data);
   }
   </script>
   ```

   :::

2. ä¸€äº›æ¶‰åŠåˆ°å¤§é‡æ•°æ®å¤§é‡è®¡ç®—å¦‚ 10 ä¸‡æ¡æ•°æ®å¯¼å‡º `excel` è¡¨æ ¼çš„ç”µå­è¡¨å•ç­‰åå°ç®¡ç†ç³»ç»Ÿä¹Ÿä¼šæ¶‰åŠåˆ° webworker

   å‰é¢æåˆ°è¿‡ webworker åªèƒ½ä½¿ç”¨çº¿ä¸Šåœ°å€ï¼Œ `import` `node_module` çš„ `xlsx` åº“ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥éœ€è¦å¯»æ‰¾ `xlsx` çº¿ä¸Šçš„ CDN å¹¶æŠŠ `js` æ–‡ä»¶æ”¾åˆ° `public` æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åé€šè¿‡ `importScripts` å¼•å…¥ã€‚

   ::: code-group

   ```js [worker.js]
   importScripts("./xlsx");
   let arr = [];
   for (let i = 0; i < 100000; i++) {
     arr.push({
       id: 1,
       name: "å¼ ä¸‰" + i + "å·",
       age: 18 + i,
       sex: i % 2 === 0 ? "ç”·" : "å¥³",
       phone: "1234567890" + i,
     });
   }
   self.addEventListener("message", (e) => {
     const sheet = XLSX.utils.json_to_sheet(arr);
     const workbook = XLSX.utils.book_new();
     XLSX.utils.book_append_sheet(workbook, sheet, "Sheet1");
     self.postMessage(workbook); // ä¿å­˜æ–‡ä»¶æ¶‰åŠåˆ° DOM æ“ä½œï¼Œå› æ­¤è¦è½¬ç§»å‡ºå»
   });
   ```

   ```vue [app.vue]
   <script>
   import { writeFile } from "xlsx";

   let worker = new Worker("http://localhost:3000/worker.js", {
     type: "module",
   });
   worker.postMessage("");
   worker.addEventListener("message", (e) => {
     writeFile(e.data, "test.xlsx");
   });
   </script>
   ```

   :::

#### æ€»ç»“

webworker ç”¨äºå¤„ç†å‰ç«¯æ€§èƒ½ç“¶é¢ˆé—®é¢˜ï¼Œåªæœ‰æ¶‰åŠåˆ°å¤§é‡è®¡ç®—æ‰ä¼šä½¿ç”¨ webworkerã€‚webworker ä¹Ÿæœ‰å¾ˆå¤šä½¿ç”¨é™åˆ¶ï¼Œå¦‚ä¸èƒ½ä½¿ç”¨ DOM æ“ä½œã€ä¸èƒ½ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ã€ä¸èƒ½ä½¿ç”¨ `import` ç­‰ã€‚
