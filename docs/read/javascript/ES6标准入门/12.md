## ç¬¬åäºŒç«  Proxy

åœ¨JavaScriptä¸­ï¼Œ`Proxy` å¯¹è±¡æä¾›äº†ä¸€ç§å…¨æ–°çš„èƒ½åŠ›ï¼Œå…è®¸æ‹¦æˆªå’Œè‡ªå®šä¹‰å¯¹è±¡çš„åŸºæœ¬æ“ä½œã€‚è¿™ç§ä»£ç†æœºåˆ¶ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿç²¾ç¡®æ§åˆ¶å¯¹è±¡çš„è¡Œä¸ºï¼Œä»å±æ€§è¯»å–åˆ°å‡½æ•°è°ƒç”¨ã€‚

### æ¦‚è¿°

Proxyç”¨äºä¿®æ”¹æŸäº›æ“ä½œçš„é»˜è®¤è¡Œä¸ºï¼Œå¯ä»¥ç†è§£ä¸ºåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚æ‹¦æˆªï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚

Proxyè¿™ä¸ªè¯çš„ä¸­æ–‡æ„æ€æ˜¯ä»£ç†ï¼Œç”¨åœ¨è¿™é‡Œè¡¨ç¤ºç”±å®ƒæ¥â€œä»£ç†â€æŸäº›æ“ä½œï¼Œå¯ä»¥è¯‘ä¸ºâ€œä»£ç†å™¨â€ã€‚

```javascript
var obj = new Proxy({},{
    get:function(target,property){
        return 35
    }
})
proxy.time //35
proxy.name //35
proxy.title //35
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`Proxy` æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰€è¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡ï¼Œå³ä¸Šé¢ä¾‹å­ä¸­çš„ç©ºå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¢«ä»£ç†çš„æ“ä½œï¼Œéœ€è¦æä¾›ä¸€ä¸ªå¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°ä¾æ¬¡ä¸ºç›®æ ‡å¯¹è±¡ã€æ‰€è¦ä»£ç†çš„å±æ€§å’Œä»£ç†æ–¹æ³•æä¾›çš„å‚æ•°ã€‚

åŸç”Ÿå¯¹è±¡çš„é»˜è®¤è¡Œä¸ºï¼Œä¼šé€šè¿‡ä¸Šé¢çš„æ‹¦æˆªï¼Œå¾—åˆ°å®šåˆ¶åŒ–çš„ç»“æœï¼Œç”±äºæ‹¦æˆªçš„å‡½æ•°å§‹ç»ˆè¿”å› 35ï¼Œå› æ­¤è®¿é—®ä»»ä½•å±æ€§è¿”å›çš„éƒ½æ˜¯35ã€‚

```javascript
var obj = new Proxy({},{
    get:function(target,key,receiver){
        console.log('getting '+key)
        return Reflect.get(target,key,receiver)
    },
    set:function(target,key,value,receiver){
        console.log('setting '+key)
        return Reflect.set(target,key,value,receiver)
    }
})
obj.count = 1; // getting count
++obj.count; // getting count // setting count
```

å…ˆä¸çœ‹`Reflect`å’Œè¿™æ®µä»£ç åšçš„ä»€ä¹ˆï¼Œé‡å¿ƒæ¥çœ‹ä¸€ä¸‹è¿è¡Œçš„ç»“æœã€‚ä¸Šé¢çš„ä»£ç è¯´æ˜ï¼Œ`Proxy` å®é™…ä¸Šé‡è½½ï¼ˆ overload ï¼‰äº†ç‚¹è¿ç®—ç¬¦ï¼Œå³ç”¨è‡ªå·±çš„å®šä¹‰è¦†ç›–äº†è¯­è¨€çš„åŸå§‹å®šä¹‰ã€‚

### å®ä¾‹æ–¹æ³•

ä¸‹é¢ä¸€ä¸€ä»‹ç» `Proxy` æ”¯æŒçš„æ‰€æœ‰æ‹¦æˆªæ“ä½œã€‚å¦‚æœæ²¡æœ‰è®¾ç½®æ‹¦æˆªï¼Œé‚£ä¹ˆé»˜è®¤çš„è¡Œä¸ºå°±æ˜¯åŸæ¥è¯­è¨€çš„è¡Œä¸ºï¼Œä»¥ `get` ä¸ºä¾‹ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½® `get` æ‹¦æˆªï¼Œè®¿é—®å¯¹è±¡å±æ€§ä¼šè¿”å›å¯¹è±¡çš„å±æ€§å€¼ã€‚

#### get()

`get` æ–¹æ³•ç”¨äºæ‹¦æˆªæŸä¸ªå±æ€§çš„è¯»å–æ“ä½œï¼Œå¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œä¾æ¬¡ä¸ºç›®æ ‡å¯¹è±¡ã€å±æ€§åå’Œ proxy å®ä¾‹æœ¬èº«ï¼ˆä¸¥æ ¼åœ°è¯´ï¼Œæ˜¯æ“ä½œè¡Œä¸ºæ‰€é’ˆå¯¹çš„å¯¹è±¡ï¼‰ï¼Œå…¶ä¸­æœ€åä¸€ä¸ªå‚æ•°å¯é€‰ã€‚

```javascript
var person = {
    name:'å¼ ä¸‰'
}
var proxy = new Proxy(person,{
    get:function(target,property){
        if(property in target){
            return target[property]
        }else{
            throw new ReferenceError('Property "' + property + '" does not exist.')
        }
    }
})
proxy.name // 'å¼ ä¸‰'
proxy.age // æŠ›å‡ºä¸€ä¸ªé”™è¯¯
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`Proxy` å¯¹è±¡ `proxy` æ‹¦æˆªå¯¹ `person` å¯¹è±¡å±æ€§`age`çš„è¯»å–æ“ä½œï¼Œå¦‚æœè¯¥å±æ€§ä¸å­˜åœ¨ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚å¦‚æœæ²¡æœ‰ `get` æ‹¦æˆªï¼Œè®¿é—®ä¸å­˜åœ¨çš„å±æ€§ï¼Œåªä¼šè¿”å› `undefined`ã€‚

`get` æ–¹æ³•å¯ä»¥ç»§æ‰¿ã€‚

```javascript
let proto = new Proxy({},{
    get:function(target,property){
        return 35
    }
})
let obj = Object.create(proto)
obj.time //35
```

ä¸Šé¢ä»£ç ä¸­ï¼Œæ‹¦æˆªæ“ä½œå®šä¹‰åœ¨ `proto` å¯¹è±¡ä¸Šé¢ï¼Œæ‰€ä»¥å¦‚æœè¯»å– `obj` å¯¹è±¡ç»§æ‰¿çš„å±æ€§ï¼Œæ‹¦æˆªä¼šç”Ÿæ•ˆã€‚

å¦‚æœç›®æ ‡å¯¹è±¡è‡ªèº«çš„æŸä¸ªå±æ€§ï¼Œä¸å¯å†™ä¸”ä¸å¯é…ç½®ï¼Œé‚£ä¹ˆ `Proxy` å¯¹åº”çš„ `get` æ‹¦æˆªä¼šæŠ¥é”™ã€‚

```javascript
const target = Object.defineProperties({},{
    a:{
        value:37,
        writable:false,
        configurable:false
    }
})
const handler = {
    get(target,prop){
        return 27
    }
}
const proxy = new Proxy(target,handler);
proxy.a // TypeError: 'get' on proxy: property 'a' is a read-only and non-configurable data property on the proxy target but the proxy did not return its actual value (expected '37' but got '27')
```

#### set()
`set` æ–¹æ³•ç”¨æ¥æ‹¦æˆªæŸä¸ªå±æ€§çš„èµ‹å€¼æ“ä½œï¼Œå¯ä»¥æ¥å—å››ä¸ªå‚æ•°ï¼Œä¾æ¬¡ä¸ºç›®æ ‡å¯¹è±¡ã€å±æ€§åã€å±æ€§å€¼å’Œ Proxy å®ä¾‹æœ¬èº«ï¼Œå…¶ä¸­æœ€åä¸€ä¸ªå‚æ•°å¯é€‰ã€‚

å‡å®š `person` å¯¹è±¡æœ‰ä¸€ä¸ª `age` å±æ€§ï¼Œè¯¥å±æ€§åº”è¯¥æ˜¯ä¸€ä¸ªä¸å¤§äº 200 çš„æ•´æ•°ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ `Proxy` æ‹¦æˆªè¿™ä¸ªå±æ€§ï¼Œå¦‚æœèµ‹å€¼çš„æ•°å€¼ä¸æ»¡è¶³è¦æ±‚ï¼Œå°±æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œä»è€Œå®ç°æ•°æ®çš„éªŒè¯å’Œè½¬æ¢ã€‚

```javascript
let validator = {
    set:function(obj,prop,value){
        if(prop === 'age'){
            if(!Number.isInteger(value)){
                throw new TypeError('The age is not an integer')
            }
            if(value > 200){
                throw new RangeError('The age seems invalid')
            }
        }
        obj[prop] = value
        return true
    }
}
let person = new Proxy({
    age:18
}, validator);
person.age = 100
person.age // 100
person.age = 'young' // æŠ›å‡ºé”™è¯¯
person.age = 300 // æŠ›å‡ºé”™è¯¯
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`validator` å¯¹è±¡æœ‰ä¸€ä¸ª `set` æ–¹æ³•ï¼Œç”¨æ¥æ‹¦æˆªå¯¹ `person` å¯¹è±¡å±æ€§ `age` çš„èµ‹å€¼æ“ä½œã€‚å¦‚æœä¸ç¬¦åˆè¦æ±‚ï¼Œå°±æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå¦åˆ™å°±è¿”å›èµ‹å€¼ç»“æœï¼Œå¹¶ä¸”è¿”å› `true`ï¼Œè¡¨ç¤ºèµ‹å€¼æˆåŠŸã€‚

> æ³¨æ„
> 
> ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œ`set` å¿…é¡»è¿”å› `true`ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

æœ‰æ—¶å€™éœ€è¦åœ¨å¯¹è±¡å†…åšå†…éƒ¨å±æ€§è®¾ç½®ï¼Œè¿™äº›å†…éƒ¨å±æ€§ä¸å¸Œæœ›è®©ä½¿ç”¨è€…å¤–éƒ¨ä¿®æ”¹ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ `set` æ–¹æ³•æ‹¦æˆªï¼Œè¿™äº›å±æ€§ç»Ÿä¸€ä¸‹åˆ’çº¿ `_` å¼€å¤´ï¼Œè¡¨ç¤ºè¿™äº›å±æ€§ä¸åº”è¯¥è¢«å¤–éƒ¨ä½¿ç”¨ã€‚

```javascript
let handler = {
    get(target, key) {
        return target[key];
    },
    set(target, key, value) {
        if (key[0] === '_') {
            throw new Error(`Invalid attempt to set private "${key}" property`);
        }
        // å¦åˆ™å°±ç…§å¸¸è®¾ç½®å±æ€§
        target[key] = value;
        return true;
    }
};
const target = {};
const proxy = new Proxy(target, handler);
proxy._prop // undefined
proxy._prop = 1; // æŠ›å‡ºé”™è¯¯ Invalid attempt to set private "_prop" property
```

> æ³¨æ„
>
> å¦‚æœç›®æ ‡å¯¹è±¡è‡ªèº«çš„æŸä¸ªå±æ€§ä¸å¯å†™ä¹Ÿä¸å¯é…ç½®ï¼Œé‚£ä¹ˆ `set` ä¸å¾—æ”¹å˜è¿™ä¸ªå±æ€§çš„å€¼ï¼Œåªèƒ½è¿”å›åŒæ ·çš„å€¼ï¼Œå¦åˆ™æŠ¥é”™ã€‚

#### apply()
`apply` æ–¹æ³•æ‹¦æˆªå‡½æ•°çš„è°ƒç”¨ã€`call` å’Œ `apply` æ“ä½œã€‚è¯¥æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ã€ç›®æ ‡å¯¹è±¡çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆ`this`ï¼‰å’Œç›®æ ‡å¯¹è±¡çš„å‚æ•°æ•°ç»„ã€‚

```javascript
var handler = {
    apply: function(target, ctx, args){
        return Reflect.apply(...arguments)
    }
}
```
ä¸‹é¢ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š
```javascript
function fn(){
    return 'æˆ‘æ˜¯fnå‡½æ•°çš„è¿”å›'
}
let handler = {
    apply:function(){
        return 'æˆ‘æ˜¯proxyçš„applyæ‹¦æˆª'
    }
}
let proxy = new Proxy(fn,handler)
proxy() // 'æˆ‘æ˜¯proxyçš„applyæ‹¦æˆª'
```

#### has()
`has` æ–¹æ³•ç”¨æ¥æ‹¦æˆª `HasProperty` æ“ä½œï¼Œå³åˆ¤æ–­å¯¹è±¡æ˜¯å¦å…·æœ‰æŸä¸ªå±æ€§æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šç”Ÿæ•ˆï¼Œä¾‹å¦‚ `in` è¿ç®—ç¬¦ã€‚å…·ä½“æ¥è¯´ï¼Œ`has` æ–¹æ³•å¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ã€éœ€æŸ¥è¯¢çš„å±æ€§åã€‚

```javascript
var handler = {
    has(target, key){
        if(key[0] === '_'){
            return false
        }
        return key in target
    }
}
var target = {
    _prop: 'foo',
    prop: 'foo'
}
var proxy = new Proxy(target, handler)
'_prop' in proxy // false
'prop' in proxy // true
```

å¦‚æœåŸå¯¹è±¡ä¸å¯é…ç½®æˆ–è€…ç¦æ­¢æ‰©å±•ï¼Œè¿™æ—¶ `has` æ‹¦æˆªä¼šæŠ¥é”™ã€‚

```js
let obj = {a: 10}
Object.preventExtensions(obj)

let p = new Proxy(obj, {
    has(target, prop) {
        return false;
    }
})

'a' in p // TypeError is thrown
```

ä½†æ˜¯ `has` æ‹¦æˆªå¯¹ `for...in` å¾ªç¯æ— æ•ˆï¼Œå³ `for...in` å¾ªç¯ä¸ä¼šè§¦å‘ `has`ã€‚

```js
let stu1 = {name: 'aa', age: 18}
let stu2 = {name: 'bb', age: 88}

let handler = {
    has(target,key) {
        if(key === 'age' &&& target[key] < 30){
            return 'young'
        }
        return 'old'
    }
}

let p1 = new Proxy(stu1, handler)
let p2 = new Proxy(stu2, handler)

'age' in p1 // 'young'
'age' in p2 // 'old'

for(let key in p1){
    console.log(p1[key]) // 'aa' 18
}

for(let key in p2){
    console.log(p2[key]) // 'bb' 88
}
```

> æ³¨æ„
> 
> `has` æ–¹æ³•æ‹¦æˆªçš„æ˜¯ `HasProperty` æ“ä½œï¼Œè€Œä¸æ˜¯ `HasOwnProperty` æ“ä½œï¼Œå³ `has` æ–¹æ³•ä¸åˆ¤æ–­ä¸€ä¸ªå±æ€§æ˜¯å¯¹è±¡è‡ªèº«çš„å±æ€§ï¼Œè¿˜æ˜¯ç»§æ‰¿çš„å±æ€§ã€‚

#### construct()
`construct` æ–¹æ³•ç”¨äºæ‹¦æˆª `new` å‘½ä»¤ï¼Œå…¶æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å¯¹è±¡ `target`ã€æ„é€ å‡½æ•°çš„å‚æ•°å¯¹è±¡ `args` å’Œ `new` å‘½ä»¤çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆ`newTarget`ï¼‰ã€‚ä¸‹é¢æ˜¯æ‹¦æˆªå¯¹è±¡çš„å†™æ³•ï¼š
```javascript
var handler = {
    construct(target, args, newTarget){
        return new target(...args)
    }
}
```

ä¸‹é¢ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š
```javascript
let p = new Proxy(function(){}, {
    construct: function(target, args){
        console.log('called: ' + args.join(', '));
        return { value: args[0] * 10 };
    }
})

new p(1) // 'called: 1' { value: 10}
```

æ³¨æ„ï¼Œ`construct` æ–¹æ³•è¿”å›çš„å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
```js
var p = new Proxy(function() {}, {
    construct: function(target, args) {
        return 1;
    }
});

new p() // TypeError: 'construct' on proxy: trap returned non-object ('1')
```

#### deleteProperty()
`deleteProperty` æ–¹æ³•ç”¨äºæ‹¦æˆª `delete` æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•æŠ›å‡ºé”™è¯¯æˆ–è€…è¿”å› `false`ï¼Œå½“å‰å±æ€§å°±æ— æ³•è¢« `delete` å‘½ä»¤åˆ é™¤ã€‚
```js
var handler = {
    deleteProperty(target, key){
        if(key[0] === '_'){
            throw new Error(`Invalid attempt to delete private "${key}" property`)
        }
        delete target[key]
        return true
    }
}

var target = {
    _prop: 'foo',
    prop: 'foo'
}

var proxy = new Proxy(target, handler)
delete proxy._prop // Error: Invalid attempt to delete private "_prop" property
delete proxy.prop // true
```
> æ³¨æ„
>
> ç›®æ ‡å¯¹è±¡è‡ªèº«çš„ä¸å¯é…ç½®çš„å±æ€§ä¸èƒ½è¢« `deleteProperty` æ–¹æ³•åˆ é™¤ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

#### defineProperty()
`defineProperty` æ–¹æ³•æ‹¦æˆªäº† `Object.defineProperty` æ“ä½œã€‚
```js
var handler = {
    defineProperty(target, key, descriptor){
        return false
    }
}

var target = {}
var proxy = new Proxy(target, handler)
Object.defineProperty(proxy, 'foo', {value: 1}) // TypeError: 'defineProperty' on proxy: trap returned falsish for property 'foo'
```
ç”±äº `defineProperty` è¿”å› `false`ï¼Œæ‰€ä»¥æ·»åŠ æ–°å±æ€§ä¼šæŠ›å‡ºé”™è¯¯ã€‚

> æ³¨æ„
> 
> å¦‚æœç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•ï¼ˆ`extensible`ï¼‰ï¼Œåˆ™ `defineProperty` ä¸èƒ½å¢åŠ ç›®æ ‡å¯¹è±¡ä¸Šä¸å­˜åœ¨çš„å±æ€§ï¼Œå¦åˆ™ä¹Ÿä¼šæŠ¥é”™ã€‚å¦å¤–ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡çš„æŸä¸ªå±æ€§ä¸å¯å†™ï¼ˆ`writable`ï¼‰æˆ–ä¸å¯é…ç½®ï¼ˆ`configurable`ï¼‰ï¼Œåˆ™ `defineProperty` æ–¹æ³•ä¸å¾—æ”¹å˜è¿™ä¸¤ä¸ªè®¾ç½®ã€‚

#### getOwnPropertyDescriptor()
`getOwnPropertyDescriptor` æ–¹æ³•æ‹¦æˆª `Object.getOwnPropertyDescriptor()`ï¼Œè¿”å›ä¸€ä¸ªå±æ€§æè¿°å¯¹è±¡æˆ–è€… `undefined`ã€‚
```js
var handler = {
    getOwnPropertyDescriptor(target, key){
        if(key[0] === '_'){
            return
        }
        return Object.getOwnPropertyDescriptor(target, key)
    }
}

var target = {
    _foo: 'bar',
    baz: 'qux'
}

var proxy = new Proxy(target, handler)
Object.getOwnPropertyDescriptor(proxy, 'wat') // undefined
Object.getOwnPropertyDescriptor(proxy, '_foo') // undefined
Object.getOwnPropertyDescriptor(proxy, 'baz') // qux
```

#### getPrototypeOf()
`getPrototypeOf` æ–¹æ³•ä¸»è¦ç”¨æ¥æ‹¦æˆªè·å–å¯¹è±¡åŸå‹ã€‚å…·ä½“æ¥è¯´ï¼Œæ‹¦æˆªä¸‹é¢è¿™äº›æ“ä½œã€‚
- `Object.prototype.__proto__`
- `Object.prototype.isPrototypeOf()`
- `Object.getPrototypeOf()`
- `Reflect.getPrototypeOf()`
- `instanceof`

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚
```js
var proto = {}
var p = new Proxy({}, {
    getPrototypeOf(target){
        return proto
    }
})
Object.getPrototypeOf(p) === proto // true
```
> æ³¨æ„
> 
> `getPrototypeOf` æ–¹æ³•åªèƒ½è¿”å›å¯¹è±¡æˆ–è€… `null`ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚å¦å¤–ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•ï¼ˆ`extensible`ï¼‰ï¼Œ `getPrototypeOf` æ–¹æ³•å¿…é¡»è¿”å›ç›®æ ‡å¯¹è±¡çš„åŸå‹å¯¹è±¡ã€‚

#### ownKeys()
`ownKeys` æ–¹æ³•ç”¨æ¥æ‹¦æˆªå¯¹è±¡è‡ªèº«å±æ€§çš„è¯»å–æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œæ‹¦æˆªä»¥ä¸‹æ“ä½œã€‚
- `Object.getOwnPropertyNames()`
- `Object.getOwnPropertySymbols()`
- `Object.keys()`

ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼š
```js
let obj = {
    a: 1,
    b: 2,
    c: 3,
}
let handler = {
    ownKeys(target){
        return ['a', 'c']
    }
}
let proxy = new Proxy(obj, handler)
Object.keys(proxy) // ["a", "c"]
```
ä¸Šè¿°ä»£ç ç”±äºå¯¹ `obj` å¯¹è±¡åšäº† `ownKeys` æ‹¦æˆªï¼Œåªè¿”å› `a` å’Œ `c` å±æ€§ï¼Œè€Œ `b` å±æ€§åˆ™è¢«æ’é™¤äº†ã€‚

`ownKeys` æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š

1. åœ¨ä½¿ç”¨ `Object.keys()` æ–¹æ³•æ—¶,æœ‰ä¸‰ç±»å±æ€§ä¼šè¢« `ownKeys` æ–¹æ³•è‡ªåŠ¨è¿‡æ»¤ï¼Œä¸ä¼šè¿”å›ã€‚åˆ†åˆ«ä¸ºï¼šç›®å‰å¯¹è±¡ä¸å­˜åœ¨çš„å±æ€§ã€å±æ€§åä¸º `Symbol` å€¼çš„å±æ€§ã€ä¸å¯éå†ï¼ˆ`enumerable`ï¼‰çš„å±æ€§ã€‚
   ```js
   let obj = {
        a: 1,
        b: 2,
        c: 3,
        [Symbol('foo')]: 4,
    }
    Object.defineProperty(obj, 'key', {
        enumerable: false,
        value: 4
    })
    let handler = {
        ownKeys(target){
            return ['a', 'c', Symbol('foo'), 'd', 'key']
        }
    }
    let proxy = new Proxy(obj, handler)
    Object.keys(proxy) // ["a", "c"]
   ```
   ä¸Šè¿°ä»£ç å› ä¸º `d` å±æ€§åœ¨ `obj` å¯¹è±¡ä¸­ä¸å­˜åœ¨ï¼Œå±æ€§å `foo` æ˜¯ `Symbol` å€¼çš„å±æ€§ï¼Œ`key` å±æ€§æ˜¯ä¸å¯éå†å±æ€§ï¼Œå› æ­¤å‡è¢« `ownKeys` æ–¹æ³•è¢«è¿‡æ»¤äº†ã€‚

2. `ownKeys` æ–¹æ³•å¯ä»¥æ‹¦æˆª `Object.getOwnPropertyNames()`ã€‚
   ```js
    let obj = {
        a: 1,
        b: 2,
        c: 3,
    }
    let handler = {
        ownKeys(target){
            return ['a', 'c']
        }
    }
    let proxy = new Proxy(obj, handler)
    Object.getOwnPropertyNames(proxy) // ["a", "c"]
   ```

3. `ownKeys` æ–¹æ³•è¿”å›çš„æ•°ç»„æˆå‘˜åªèƒ½æ˜¯å­—ç¬¦ä¸²æˆ– `Symbol`ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
   ```js
    let obj = {}

    let handler = {
        ownKeys(target){
            return [123, true, undefined, null, {}, []]
        }
    }
    let proxy = new Proxy(obj, handler)
    Object.getOwnPropertyNames(proxy) // TypeError: 123 is not a valid property name
   ```

4. å¦‚æœç›®æ ‡å¯¹è±¡è‡ªèº«åŒ…å«ä¸å¯é…ç½®çš„å±æ€§ï¼Œåˆ™ `ownKeys` æ–¹æ³•è¿”å›çš„æ•°ç»„ä¹‹ä¸­å¿…é¡»åŒ…å«è¯¥å±æ€§ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
   ```js
    let obj = {}
    Object.defineProperty(obj, 'key', {
        configurable: false,
        enumerable: true,
        value: 4
    })
    let handler = {
        ownKeys(target){
            return ['a', 'c']
        }
    }
    let proxy = new Proxy(obj, handler)
    Object.getOwnPropertyNames(proxy) // TypeError: 'ownKeys' on proxy: trap returned did not include 'key'
   ```

5. å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯ä¸å¯æ‰©å±•çš„ï¼ˆnon-extensibleï¼‰ï¼Œåˆ™ `ownKeys` æ–¹æ³•è¿”å›çš„æ•°ç»„ä¹‹ä¸­å¿…é¡»åŒ…å«ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œä¸”ä¸èƒ½åŒ…å«å¤šä½™çš„å±æ€§ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
   ```js
    let obj = {
        a: 1,
        b: 2,
        c: 3,
    }
    Object.preventExtensions(obj)
    let handler = {
        ownKeys(target){
            return ['a', 'c', 'd']
        }
    }
    let proxy = new Proxy(obj, handler)
    Object.getOwnPropertyNames(proxy) // TypeError: 'ownKeys' on proxy: trap returned extra keys but proxy target is non-extensible
   ```

#### preventExtensions()
`preventExtensions` æ–¹æ³•æ‹¦æˆª `Object.preventExtensions` æ“ä½œã€‚è¯¥æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦åˆ™ä¼šè¢«è‡ªåŠ¨è½¬ä¸ºå¸ƒå°”å€¼ã€‚
> æ³¨æ„
>
> `preventExtensions` æ–¹æ³•æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œåªæœ‰ç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•æ—¶ï¼Œ`preventExtensions` æ–¹æ³•æ‰èƒ½è¿”å› `true`ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚
> ```js
> let p = new Proxy({}, {
>     preventExtensions: function(target){
>         return true
>     }
> })
> Object.preventExtensions(p) // TypeError: 'preventExtensions' on proxy: trap returned falsish
> ```
> ä¸ºäº†é˜²æ­¢è¿™ç§é—®é¢˜ï¼Œéœ€è¦åœ¨ `proxy.preventExtensions` æ–¹æ³•ä¸­è°ƒç”¨ä¸€æ¬¡ `Object.preventExtensions`ã€‚

#### isExtensible()
`isExtensible` æ–¹æ³•æ‹¦æˆª `Object.isExtensible` æ“ä½œã€‚
```js
var p = new Proxy({}, {
    isExtensible: function(target){
        console.log('called')
        return true
    }
})

Object.isExtensible(p) // "called"
```
> æ³¨æ„
> 
> `isExtensible` æ–¹æ³•åªèƒ½è¿”å›å¸ƒå°”å€¼ï¼Œè¿”å›å€¼ä¼šè‡ªåŠ¨è¢«è½¬æ¢ä¸ºå¸ƒå°”å€¼ã€‚`isExtensible` æ–¹æ³•æœ‰ä¸€ä¸ªå¼ºé™åˆ¶ï¼Œå®ƒçš„è¿”å›å€¼å¿…é¡»ä¸ç›®æ ‡å¯¹è±¡çš„ `isExtensible` å±æ€§ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ›å‡ºé”™è¯¯ã€‚

#### setPrototypeOf()
`setPrototypeOf` æ–¹æ³•ç”¨äºæ‹¦æˆª `Object.setPrototypeOf` æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯åŸå‹å¯¹è±¡ã€‚
```js
var handler = {
    setPrototypeOf(target, proto){
        throw new Error('Changing the prototype is forbidden')
    }
}
var proto = {}
var target = function(){}
var proxy = new Proxy(target, handler)
Object.setPrototypeOf(proxy, proto) // Error: Changing the prototype is forbidden
```
> æ³¨æ„
>
> `setPrototypeOf` æ–¹æ³•åªèƒ½è¿”å›å¸ƒå°”å€¼ï¼Œå¦åˆ™ä¼šè¢«è‡ªåŠ¨è½¬ä¸ºå¸ƒå°”å€¼ã€‚å¦å¤–ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡ä¸å¯æ‰©å±•ï¼ˆnon-extensibleï¼‰ï¼Œ`setPrototypeOf` æ–¹æ³•ä¸å¾—æ”¹å˜ç›®æ ‡å¯¹è±¡çš„åŸå‹ã€‚å¦åˆ™ä¼šæŠ¥é”™ã€‚

### Proxy.revocable()
`Proxy.revocable` æ–¹æ³•è¿”å›ä¸€ä¸ªå¯å–æ¶ˆçš„ `Proxy` å®ä¾‹ã€‚
```js
let target = {}
let handler = {}
let {proxy, revoke} = Proxy.revocable(target, handler)
proxy.foo = 123
proxy.foo // 123
revoke()
proxy.foo // TypeError: Revoked
```
> æ³¨æ„
>
> `Proxy.revocable` æ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„ `proxy` å±æ€§æ˜¯ `Proxy` å®ä¾‹ï¼Œ`revoke` å±æ€§æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å–æ¶ˆ `Proxy` å®ä¾‹ã€‚ä¸€æ—¦ `revoke` å‡½æ•°æ‰§è¡Œï¼Œ`Proxy` å®ä¾‹å°±ä¼šå¤±æ•ˆã€‚

ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œç›®æ ‡å¯¹è±¡ä¸å…è®¸ç›´æ¥è®¿é—®ï¼Œå¿…é¡»é€šè¿‡ä»£ç†è®¿é—®ï¼Œä¸€æ—¦è®¿é—®ç»“æŸï¼Œå°±æ”¶å›ä»£ç†æƒï¼Œä¸å…è®¸å†æ¬¡è®¿é—®ã€‚

### this é—®é¢˜
åœ¨ `Proxy` ä»£ç†çš„æƒ…å†µä¸‹ï¼Œç›®æ ‡å¯¹è±¡å†…éƒ¨çš„ `this` å…³é”®å­—ä¼šæŒ‡å‘ `Proxy` å®ä¾‹ã€‚
```js
var target = {
    m: function(){
        console.log(this === proxy)
    }
}
var proxy = new Proxy(target, {})
target.m() // false
proxy.m() // true
```
æœ‰äº›åŸç”Ÿå¯¹è±¡çš„ `this` é”™è¯¯ï¼Œåªæœ‰åœ¨ `Proxy` ä¸‹æ‰èƒ½ä¿®å¤ï¼Œæ¯”å¦‚ `Date` å¯¹è±¡ã€‚
```js
var d = new Date()
d.getTime() // 1488488835657
var proxy = new Proxy(d, {})
proxy.getTime() // 1488488835657
```

### æ€»ç»“
Proxy æ˜¯ JavaScript ä¸­ç”¨äºæ‹¦æˆªå’Œä¿®æ”¹å¯¹è±¡æ“ä½œçš„ä»£ç†å™¨ï¼Œå®ƒå…è®¸åœ¨è®¿é—®å¯¹è±¡å±æ€§æˆ–æ–¹æ³•æ—¶è¿›è¡Œè‡ªå®šä¹‰è¡Œä¸ºã€‚

Proxy æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šç›®æ ‡å¯¹è±¡å’Œå¤„ç†ç¨‹åºå¯¹è±¡ï¼Œåè€…å®šä¹‰äº†æ‹¦æˆªæ“ä½œçš„è¡Œä¸ºã€‚æ‹¦æˆªæ“ä½œåŒ…æ‹¬å±æ€§è¯»å–ï¼ˆgetï¼‰ã€å±æ€§èµ‹å€¼ï¼ˆsetï¼‰ã€å‡½æ•°è°ƒç”¨ï¼ˆapplyï¼‰ã€å±æ€§å­˜åœ¨æ€§æ£€æŸ¥ï¼ˆhasï¼‰ã€æ„é€ å‡½æ•°è°ƒç”¨ï¼ˆconstructï¼‰ã€å±æ€§åˆ é™¤ï¼ˆdeletePropertyï¼‰ã€å±æ€§æè¿°ç¬¦è·å–ï¼ˆgetOwnPropertyDescriptorï¼‰ã€åŸå‹é“¾è·å–ï¼ˆgetPrototypeOfï¼‰ã€è‡ªèº«å±æ€§è¯»å–ï¼ˆownKeysï¼‰ã€å¯¹è±¡æ‰©å±•æ€§æ£€æŸ¥ï¼ˆisExtensibleï¼‰å’ŒåŸå‹è®¾ç½®ï¼ˆsetPrototypeOfï¼‰ç­‰ã€‚

Proxy.revocable æ–¹æ³•å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯æ’¤é”€çš„ Proxy å®ä¾‹ï¼Œé€šè¿‡è°ƒç”¨ revoke å‡½æ•°æ¥å–æ¶ˆä»£ç†ã€‚åœ¨ Proxy ä¸­ï¼Œç›®æ ‡å¯¹è±¡å†…éƒ¨çš„ this æŒ‡å‘ Proxy å®ä¾‹ï¼Œè€Œä¸æ˜¯ç›®æ ‡å¯¹è±¡æœ¬èº«ã€‚è¿™ä½¿å¾— Proxy æˆä¸ºä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨ä¸ç›´æ¥ä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œæ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—®å’Œæ“ä½œã€‚